<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PRODESK | Enhanced Options Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');

        :root {
            --bg-main: #0f172a;
            --bg-panel: rgba(30, 41, 59, 0.7);
            --text-primary: #f8fafc;
            --text-muted: #94a3b8;
            --border-subtle: rgba(255, 255, 255, 0.05);
            --color-primary: #3b82f6;
            --input-bg: #1e293b;
            --tab-inactive: #64748b;
        }

        body.light-theme {
            --bg-main: #f1f5f9;
            --bg-panel: rgba(255, 255, 255, 0.9);
            --text-primary: #0f172a;
            --text-muted: #475569;
            --border-subtle: rgba(0, 0, 0, 0.1);
            --input-bg: #ffffff;
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg-main); color: var(--text-primary); transition: background-color 0.3s, color 0.3s; }
        .glass-panel { background: var(--bg-panel); backdrop-filter: blur(12px); border: 1px solid var(--border-subtle); }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        .flash-up { animation: flash-green 0.8s ease-out; }
        .flash-down { animation: flash-red 0.8s ease-out; }
        @keyframes flash-green { 0% { background-color: rgba(34, 197, 94, 0.3); } 100% { background-color: transparent; } }
        @keyframes flash-red { 0% { background-color: rgba(239, 68, 68, 0.3); } 100% { background-color: transparent; } }

        .sticky-header th { position: sticky; top: 0; z-index: 10; background: var(--header-bg); }
        .tab-active { border-bottom: 2px solid #3b82f6; color: #3b82f6; }
        .greek-positive { color: #22c55e; }
        .greek-negative { color: #ef4444; }

        /* Component Overrides for Themes */
        .theme-text-muted { color: var(--text-muted); }
        .theme-input { background-color: var(--input-bg); border: 1px solid var(--border-subtle); color: var(--text-primary); }
        .light-theme .text-white { color: var(--text-primary); }
        .light-theme .text-gray-400 { color: #475569; }
        .light-theme .text-gray-500 { color: #64748b; }
        .light-theme .bg-slate-900 { background-color: #e2e8f0; }
        .light-theme .bg-slate-800 { background-color: #f1f5f9; }
        .light-theme .bg-black\/40 { background-color: rgba(255, 255, 255, 0.5); }
    </style>
</head>
<body class="h-full flex flex-col overflow-hidden custom-scrollbar light-theme">
    <!-- Header -->
    <header class="h-14 py-2 glass-panel border-b border-white/5 px-4 md:px-6 flex items-center justify-between shrink-0">
        <div class="flex items-center gap-6">
            <div class="flex flex-col">
                <a href="/" class="text-sm font-black text-white italic tracking-tighter uppercase shrink-0">
                    PRO<span class="text-blue-500">DESK</span> <span class="text-xs not-italic font-bold text-gray-500 ml-1">OPTIONS</span>
                </a>
            </div>
            <div class="flex items-center gap-4 text-[10px] text-gray-400">
                <span>Source: <span id="dataSource" class="text-green-400 font-bold">-</span></span>
                <span>Updated: <span id="lastUpdated" class="text-blue-400 font-bold">-</span></span>
                <select id="underlyingSelect" class="bg-gray-900 border border-white/10 rounded px-2 py-0.5 text-xs font-bold text-blue-500 outline-none focus:ring-1 focus:ring-blue-500">
                    <option value="NSE:NIFTY">NIFTY 50</option>
                    <option value="NSE:BANKNIFTY">BANKNIFTY</option>
                    <option value="NSE:FINNIFTY">FINNIFTY</option>
                </select>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <div class="flex items-center gap-1 bg-black/20 p-1 rounded-full border border-white/5">
                <button id="refreshBtn" class="bg-blue-600 hover:bg-blue-700 text-white text-[9px] font-black px-4 py-1.5 rounded-full transition-all uppercase italic tracking-tighter">
                    Refresh
                </button>
                <button id="backfillBtn" class="bg-gray-800 hover:bg-gray-700 text-white text-[9px] font-black px-4 py-1.5 rounded-full transition-all uppercase italic tracking-tighter ml-1">
                    Backfill
                </button>
                <button id="alertsBtn" class="text-gray-400 hover:text-white p-1.5 transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>
                </button>
                <button id="strategyBtn" class="text-gray-400 hover:text-white p-1.5 transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                </button>
            </div>
            <button id="optionsThemeToggle" class="p-2 hover:bg-white/5 rounded-full text-gray-400 transition-colors ml-2" title="Toggle Theme">
                <svg id="optionsSunIcon" class="hidden w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"/></svg>
                <svg id="optionsMoonIcon" class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"/></svg>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar">
        <!-- Summary Cards Section -->
        <div class="space-y-4">
            <!-- Row 1: Core Metrics -->
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- Spot Price -->
                <div class="glass-panel rounded-xl p-3 flex flex-col justify-between shadow-sm">
                    <div class="text-[10px] text-gray-500 font-black uppercase tracking-widest flex justify-between items-center">
                        Spot Price
                        <div id="spotSentiment" class="text-[8px] font-black bg-green-500/20 text-green-500 px-1.5 py-0.5 rounded uppercase">BULLISH</div>
                    </div>
                    <div class="flex items-baseline gap-2 mt-1">
                        <div id="spotPrice" class="text-xl font-black text-white tracking-tighter">0.00</div>
                        <div class="text-[9px] text-gray-500 font-bold">AIM: <span id="aimSpot" class="text-blue-500">-</span></div>
                    </div>
                </div>

                <!-- PCR -->
                <div class="glass-panel rounded-xl p-3 flex flex-col justify-between shadow-sm">
                    <div class="text-[10px] text-gray-500 font-black uppercase tracking-widest flex justify-between items-center">
                        PCR (OI)
                        <div id="pcrSignal" class="text-[8px] font-black bg-gray-500/20 text-gray-400 px-1.5 py-0.5 rounded uppercase">NEUTRAL</div>
                    </div>
                    <div class="flex items-baseline gap-2 mt-1">
                        <div id="pcrValue" class="text-xl font-black text-white tracking-tighter">0.00</div>
                        <div class="text-[9px] text-gray-500 font-bold">Vol: <span id="pcrVol" class="text-blue-500">-</span></div>
                    </div>
                </div>

                <!-- Max Pain -->
                <div class="glass-panel rounded-xl p-3 flex flex-col justify-between shadow-sm">
                    <div class="text-[10px] text-gray-500 font-black uppercase tracking-widest flex justify-between items-center">
                        Max Pain
                        <div id="maxPainDiff" class="text-[8px] font-black text-gray-400 uppercase tracking-tighter">-</div>
                    </div>
                    <div class="flex items-baseline gap-2 mt-1">
                        <div id="maxPain" class="text-xl font-black text-white tracking-tighter">0.00</div>
                        <div class="text-[8px] text-gray-500 font-bold">EXP: <span id="expiryDate" class="text-blue-500">-</span></div>
                    </div>
                </div>

                <!-- IV Rank -->
                <div class="glass-panel rounded-xl p-3 flex flex-col justify-between shadow-sm">
                    <div class="text-[10px] text-gray-500 font-black uppercase tracking-widest flex justify-between items-center">
                        IV Rank
                        <div id="ivSignal" class="text-[8px] font-black bg-gray-500/20 text-gray-400 px-1.5 py-0.5 rounded uppercase">-</div>
                    </div>
                    <div class="flex items-baseline gap-2 mt-1">
                        <div id="ivRank" class="text-xl font-black text-white tracking-tighter">-</div>
                        <div class="text-[9px] text-gray-500 font-bold">IV: <span id="ivValue" class="text-blue-500">-</span>%</div>
                    </div>
                </div>
            </div>

            <!-- Row 2: Insights & Secondary -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                <!-- Genie Insights Card -->
                <div class="lg:col-span-2 glass-panel rounded-xl p-3 border-l-4 border-blue-500 flex items-center justify-between shadow-md">
                    <div class="flex-1">
                        <div class="text-[10px] text-blue-500 font-black uppercase tracking-widest flex items-center gap-3">
                            OiGenie Market Control
                            <span id="sidewaysBadge" class="hidden text-[8px] bg-yellow-500/20 text-yellow-500 px-2 py-0.5 rounded">SIDEWAYS EXPECTED</span>
                        </div>
                        <div class="flex items-center gap-6 mt-1">
                            <div id="genieControl" class="text-lg font-black text-white uppercase tracking-tight">-</div>
                            <div class="h-4 w-px bg-white/10"></div>
                            <div id="genieDistribution" class="text-[10px] font-bold text-gray-500 uppercase">-</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-[9px] text-gray-500 font-black uppercase">Institutional Range</div>
                        <div id="genieRange" class="text-sm text-blue-500 font-black tracking-tighter">-</div>
                    </div>
                </div>

                <!-- Net Greeks -->
                <div class="glass-panel rounded-xl p-3 flex items-center justify-between shadow-sm">
                    <div class="flex flex-col">
                        <div class="text-[10px] text-gray-500 font-black uppercase tracking-widest">Net Delta</div>
                        <div id="netDelta" class="text-xl font-black text-white mt-1">-</div>
                    </div>
                    <div class="text-right">
                        <div id="deltaSignal" class="text-[8px] font-black bg-gray-500/20 text-gray-400 px-1.5 py-0.5 rounded uppercase mb-1">-</div>
                        <div class="text-[9px] text-gray-500 font-bold italic">Theta: <span id="netTheta" class="text-red-400">-</span></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="flex gap-6 border-b border-white/10 pt-2">
            <button class="tab-btn tab-active pb-2 text-xs font-bold uppercase tracking-wider" data-tab="chain">Option Chain</button>
            <button class="tab-btn pb-2 text-xs font-bold text-gray-500 uppercase tracking-wider hover:text-white transition-colors" data-tab="oi-analysis">OI Analysis</button>
            <button class="tab-btn pb-2 text-xs font-bold text-gray-500 uppercase tracking-wider hover:text-white transition-colors" data-tab="pcr-trend">PCR Trend</button>
            <button class="tab-btn pb-2 text-xs font-bold text-gray-500 uppercase tracking-wider hover:text-white transition-colors" data-tab="greeks">Greeks</button>
            <button class="tab-btn pb-2 text-xs font-bold text-gray-500 uppercase tracking-wider hover:text-white transition-colors" data-tab="buildup">OI Buildup</button>
            <button class="tab-btn pb-2 text-xs font-bold text-gray-500 uppercase tracking-wider hover:text-white transition-colors" data-tab="strategies">Strategies</button>
            <button class="tab-btn pb-2 text-xs font-bold text-gray-500 uppercase tracking-wider hover:text-white transition-colors" data-tab="alerts">Alerts</button>
            <button class="tab-btn pb-2 text-xs font-bold text-gray-500 uppercase tracking-wider hover:text-white transition-colors" data-tab="scalper">Scalper</button>
        </div>

        <!-- Tab Content -->
        <div id="tabContent">
            <!-- Option Chain Tab -->
            <div id="chainTab" class="tab-pane">
                <div class="glass-panel rounded-xl overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-[10px]">
                            <thead class="sticky-header">
                                <tr class="bg-slate-800 text-gray-400">
                                    <th colspan="6" class="py-2 px-3 text-center text-green-500 font-bold border-r border-white/5">CALLS</th>
                                    <th class="py-2 px-3 text-center bg-slate-700 text-white border-r border-white/5">STRIKE</th>
                                    <th colspan="6" class="py-2 px-3 text-center text-red-500 font-bold">PUTS</th>
                                </tr>
                                <tr class="bg-slate-900 text-gray-500">
                                    <th class="py-2 px-3 text-right">IV</th>
                                    <th class="py-2 px-3 text-right">Delta</th>
                                    <th class="py-2 px-3 text-right">Theta</th>
                                    <th class="py-2 px-3 text-right">LTP</th>
                                    <th class="py-2 px-3 text-right">OI Chg</th>
                                    <th class="py-2 px-3 text-right border-r border-white/5">OI</th>
                                    <th class="py-2 px-3 text-center bg-slate-800"></th>
                                    <th class="py-2 px-3 text-left">OI</th>
                                    <th class="py-2 px-3 text-left">OI Chg</th>
                                    <th class="py-2 px-3 text-left">LTP</th>
                                    <th class="py-2 px-3 text-left">Theta</th>
                                    <th class="py-2 px-3 text-left">Delta</th>
                                    <th class="py-2 px-3 text-left">IV</th>
                                </tr>
                            </thead>
                            <tbody id="optionChainBody" class="divide-y divide-white/5">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- OI Analysis Tab -->
            <div id="oi-analysisTab" class="tab-pane hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <div class="glass-panel rounded-xl p-4">
                        <h3 class="text-xs font-bold uppercase tracking-wider mb-4">OI Distribution</h3>
                        <div class="h-[300px] relative">
                            <canvas id="oiChart"></canvas>
                        </div>
                    </div>
                    <div class="glass-panel rounded-xl p-4">
                        <h3 class="text-xs font-bold uppercase tracking-wider mb-4">Support & Resistance</h3>
                        <div id="supportResistance" class="space-y-2">
                            <!-- Dynamic content -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- PCR Trend Tab -->
            <div id="pcr-trendTab" class="tab-pane hidden">
                <div class="grid grid-cols-1 gap-4">
                    <div class="glass-panel rounded-xl p-4">
                        <h3 class="text-xs font-bold uppercase tracking-wider mb-4">Spot vs PCR Confluence</h3>
                        <div class="h-[400px] relative">
                            <canvas id="confluenceChart"></canvas>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                        <div class="glass-panel rounded-xl p-4">
                            <h3 class="text-xs font-bold uppercase tracking-wider mb-4">Total OI Trend</h3>
                            <div class="h-[300px] relative">
                                <canvas id="totalOIChart"></canvas>
                            </div>
                        </div>
                        <div class="glass-panel rounded-xl p-4">
                            <h3 class="text-xs font-bold uppercase tracking-wider mb-4">OI Change Trend</h3>
                            <div class="h-[300px] relative">
                                <canvas id="oiChangeChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Greeks Tab -->
            <div id="greeksTab" class="tab-pane hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <div class="glass-panel rounded-xl p-4">
                        <h3 class="text-xs font-bold uppercase tracking-wider mb-4">Delta Distribution</h3>
                        <div class="h-[300px] relative">
                            <canvas id="deltaChart"></canvas>
                        </div>
                    </div>
                    <div class="glass-panel rounded-xl p-4">
                        <h3 class="text-xs font-bold uppercase tracking-wider mb-4">Theta (Time Decay)</h3>
                        <div class="h-[300px] relative">
                            <canvas id="thetaChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- OI Buildup Tab -->
            <div id="buildupTab" class="tab-pane hidden">
                <div class="glass-panel rounded-xl p-4">
                    <h3 class="text-xs font-bold uppercase tracking-wider mb-4">OI Buildup Analysis</h3>
                    <div id="buildupAnalysis" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <!-- Dynamic content -->
                    </div>
                </div>
            </div>

            <!-- Strategies Tab -->
            <div id="strategiesTab" class="tab-pane hidden">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <div class="glass-panel rounded-xl p-4">
                        <h3 class="text-xs font-bold uppercase tracking-wider mb-4">Strategy Builder</h3>
                        <div class="space-y-3">
                            <select id="strategyType" class="w-full bg-slate-900 border border-white/10 rounded px-3 py-2 text-xs">
                                <option value="bull_call_spread">Bull Call Spread</option>
                                <option value="bear_put_spread">Bear Put Spread</option>
                                <option value="iron_condor">Iron Condor</option>
                                <option value="long_straddle">Long Straddle</option>
                                <option value="long_strangle">Long Strangle</option>
                                <option value="custom">Custom Strategy</option>
                            </select>

                            <div id="customLegsContainer" class="hidden space-y-2 border-t border-white/5 pt-2">
                                <div class="flex justify-between items-center">
                                    <span class="text-[10px] text-gray-400 uppercase">Legs</span>
                                    <button id="addLegBtn" class="text-blue-500 text-[10px] font-bold">+ Add Leg</button>
                                </div>
                                <div id="legsList" class="space-y-2 max-h-60 overflow-y-auto custom-scrollbar">
                                    <!-- Dynamic legs -->
                                </div>
                            </div>

                            <button id="buildStrategyBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold py-2 rounded transition-all">
                                Build Strategy
                            </button>
                        </div>
                    </div>
                    <div class="glass-panel rounded-xl p-4 lg:col-span-2 flex flex-col">
                        <h3 class="text-xs font-bold uppercase tracking-wider mb-4">Strategy Analysis</h3>
                        <div id="strategyAnalysis" class="flex-1 overflow-y-auto custom-scrollbar pr-2">
                            <p class="text-gray-500 text-xs">Select a strategy to see analysis</p>
                        </div>
                        <div id="payoffChartContainer" class="hidden mt-4 pt-4 border-t border-white/5 h-[250px] relative">
                            <canvas id="payoffChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Alerts Tab -->
            <div id="alertsTab" class="tab-pane hidden">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <div class="glass-panel rounded-xl p-4">
                        <h3 class="text-xs font-bold uppercase tracking-wider mb-4">Create Alert</h3>
                        <div class="space-y-3">
                            <input id="alertName" type="text" placeholder="Alert Name" class="w-full bg-slate-900 border border-white/10 rounded px-3 py-2 text-xs">
                            <select id="alertType" class="w-full bg-slate-900 border border-white/10 rounded px-3 py-2 text-xs">
                                <option value="price_above">Price Above</option>
                                <option value="price_below">Price Below</option>
                                <option value="pcr_above">PCR Above</option>
                                <option value="pcr_below">PCR Below</option>
                                <option value="iv_rank_above">IV Rank Above</option>
                                <option value="iv_rank_below">IV Rank Below</option>
                            </select>
                            <input id="alertThreshold" type="number" step="0.01" placeholder="Threshold Value" class="w-full bg-slate-900 border border-white/10 rounded px-3 py-2 text-xs">
                            <button id="createAlertBtn" class="w-full bg-purple-600 hover:bg-purple-700 text-white text-xs font-bold py-2 rounded transition-all">
                                Create Alert
                            </button>
                        </div>
                    </div>
                    <div class="glass-panel rounded-xl p-4 lg:col-span-2">
                        <h3 class="text-xs font-bold uppercase tracking-wider mb-4">Active Alerts</h3>
                        <div id="alertsList" class="space-y-2">
                            <!-- Dynamic content -->
                            <p class="text-gray-500 text-xs">Loading alerts...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Scalper Tab -->
            <div id="scalperTab" class="tab-pane hidden">
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
                    <div class="lg:col-span-1 space-y-4">
                        <div class="glass-panel rounded-xl p-4">
                            <h3 class="text-xs font-bold uppercase tracking-wider mb-4">Scalper Control</h3>
                            <div class="space-y-3">
                                <div class="flex flex-col gap-1">
                                    <label class="text-[10px] text-gray-500 uppercase">Underlying</label>
                                    <select id="scalperUnderlying" class="w-full bg-slate-900 border border-white/10 rounded px-3 py-2 text-xs">
                                        <option value="NSE:NIFTY">NIFTY 50</option>
                                        <option value="NSE:BANKNIFTY">BANKNIFTY</option>
                                        <option value="NSE:FINNIFTY">FINNIFTY</option>
                                    </select>
                                </div>
                                <div id="scalperStatus" class="flex items-center gap-2 py-2 px-3 bg-slate-900/50 rounded border border-white/5">
                                    <div id="statusDot" class="w-2 h-2 rounded-full bg-red-500"></div>
                                    <span id="statusText" class="text-[10px] font-bold text-gray-400 uppercase">Inactive</span>
                                </div>
                                <button id="startScalperBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold py-2 rounded transition-all">
                                    Start Scalper
                                </button>
                                <button id="stopScalperBtn" class="w-full bg-red-600 hover:bg-red-700 text-white text-xs font-bold py-2 rounded transition-all hidden">
                                    Stop Scalper
                                </button>
                            </div>
                        </div>
                        <div class="glass-panel rounded-xl p-4">
                            <h3 class="text-xs font-bold uppercase tracking-wider mb-2">Active Trades</h3>
                            <div id="activeTradesList" class="space-y-2">
                                <p class="text-[10px] text-gray-500">No active trades</p>
                            </div>
                        </div>
                    </div>
                    <div class="lg:col-span-3 space-y-4">
                        <!-- Confluence Metrics -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="glass-panel rounded-xl p-3 border-l-4 border-blue-500">
                                <div class="text-[10px] text-gray-400 uppercase font-bold">OI Power</div>
                                <div id="scalperOIPower" class="text-lg font-black text-white mt-1">-</div>
                            </div>
                            <div class="glass-panel rounded-xl p-3 border-l-4 border-purple-500">
                                <div class="text-[10px] text-gray-400 uppercase font-bold">Sentiment</div>
                                <div id="scalperOISentiment" class="text-lg font-black text-white mt-1">-</div>
                            </div>
                            <div class="glass-panel rounded-xl p-3 border-l-4 border-orange-500">
                                <div class="text-[10px] text-gray-400 uppercase font-bold">OI Status</div>
                                <div id="scalperOIStatus" class="text-lg font-black text-white mt-1">-</div>
                            </div>
                            <div class="glass-panel rounded-xl p-3 border-l-4 border-green-500">
                                <div class="text-[10px] text-gray-400 uppercase font-bold">Signal Zone</div>
                                <div id="scalperSignalZone" class="text-lg font-black text-white mt-1">-</div>
                            </div>
                        </div>

                        <!-- Confluence Checkbox Grid -->
                        <div class="grid grid-cols-5 gap-4">
                            <div id="conf-lvl" class="glass-panel rounded-lg p-3 text-center border border-white/5 opacity-40">
                                <div class="text-[9px] text-gray-400 uppercase font-bold">Lvl Hunt</div>
                                <div class="text-xs font-black mt-1">ZONE</div>
                            </div>
                            <div id="conf-pcr" class="glass-panel rounded-lg p-3 text-center border border-white/5 opacity-40">
                                <div class="text-[9px] text-gray-400 uppercase font-bold">PCR Trend</div>
                                <div class="text-xs font-black mt-1">PULSE</div>
                            </div>
                            <div id="conf-oi" class="glass-panel rounded-lg p-3 text-center border border-white/5 opacity-40">
                                <div class="text-[9px] text-gray-400 uppercase font-bold">OI Spurt</div>
                                <div class="text-xs font-black mt-1">SMART</div>
                            </div>
                            <div id="conf-brk" class="glass-panel rounded-lg p-3 text-center border border-white/5 opacity-40">
                                <div class="text-[9px] text-gray-400 uppercase font-bold">Option Brk</div>
                                <div class="text-xs font-black mt-1">MOMENTUM</div>
                            </div>
                            <div id="conf-inv" class="glass-panel rounded-lg p-3 text-center border border-white/5 opacity-40">
                                <div class="text-[9px] text-gray-400 uppercase font-bold">Inverse Dn</div>
                                <div class="text-xs font-black mt-1">CONFIRM</div>
                            </div>
                        </div>

                        <div class="glass-panel rounded-xl p-4 h-[450px] flex flex-col">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xs font-bold uppercase tracking-wider">Scalper Log Pulse</h3>
                                <div class="flex gap-4 items-center">
                                    <div class="flex gap-2 text-[9px]">
                                        <span class="text-gray-500">CE VWAP: <span id="ceVwap" class="text-blue-400 font-bold">-</span></span>
                                        <span class="text-gray-500">PE VWAP: <span id="peVwap" class="text-red-400 font-bold">-</span></span>
                                    </div>
                                    <button id="clearLogBtn" class="text-[10px] text-gray-500 hover:text-white uppercase font-bold">Clear Log</button>
                                </div>
                            </div>
                            <div id="scalperLog" class="flex-1 bg-black/40 rounded p-4 font-mono text-[11px] overflow-y-auto custom-scrollbar space-y-1">
                                <p class="text-gray-600 italic">Connecting to scalper stream...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Global state
        let currentUnderlying = 'NSE:NIFTY';
        let socket = null;
        let charts = {};
        let theme = localStorage.getItem('theme') || 'light';

        function applyTheme(newTheme) {
            theme = newTheme;
            localStorage.setItem('theme', theme);
            if (theme === 'light') {
                document.body.classList.add('light-theme');
                document.getElementById('optionsSunIcon')?.classList.add('hidden');
                document.getElementById('optionsMoonIcon')?.classList.remove('hidden');
            } else {
                document.body.classList.remove('light-theme');
                document.getElementById('optionsSunIcon')?.classList.remove('hidden');
                document.getElementById('optionsMoonIcon')?.classList.add('hidden');
            }
            // Redraw charts if needed
            const textColor = theme === 'light' ? '#0f172a' : '#f8fafc';
            const mutedColor = theme === 'light' ? '#475569' : '#94a3b8';
            const gridColor = theme === 'light' ? 'rgba(0,0,0,0.05)' : 'rgba(255,255,255,0.05)';

            Object.values(charts).forEach(chart => {
                if (chart && chart.options && chart.options.scales) {
                    // Update all scales (x, y, y-spot, y-pcr, etc)
                    Object.values(chart.options.scales).forEach(scale => {
                        if (scale.ticks) scale.ticks.color = mutedColor;
                        if (scale.grid) scale.grid.color = gridColor;
                        if (scale.title) scale.title.color = (scale.title.text === 'SPOT PRICE' || scale.title.text === 'PCR') ? scale.title.color : textColor;
                    });

                    if (chart.options.plugins.legend && chart.options.plugins.legend.labels) {
                        chart.options.plugins.legend.labels.color = textColor;
                    }
                    chart.update();
                }
            });
        }

        function formatIST(timestamp) {
            return new Intl.DateTimeFormat('en-IN', {
                timeZone: 'Asia/Kolkata',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            }).format(new Date(timestamp));
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            applyTheme(localStorage.getItem('theme') || 'light');
            initSocket();
            loadData();
            setupEventListeners();

            // Auto-refresh every 2 minutes
            setInterval(loadData, 120000);
        });

        function initSocket() {
            if (typeof io === 'undefined') {
                console.error('Socket.io not loaded');
                return;
            }
            socket = io();
            
            socket.on('connect', () => {
                console.log('Socket connected');
                socket.emit('subscribe_options', { underlying: currentUnderlying });
                socket.emit('subscribe', { instrumentKeys: [currentUnderlying], interval: '1' });
            });

            socket.on('raw_tick', (data) => {
                for (const [key, quote] of Object.entries(data)) {
                    if (key.toUpperCase() === currentUnderlying.toUpperCase()) {
                        const price = parseFloat(quote.last_price);
                        if (!isNaN(price) && price > 0) {
                            document.getElementById('spotPrice').textContent = price.toLocaleString(undefined, {minimumFractionDigits: 2});
                        }
                    }
                }
            });

            socket.on('chart_update', (data) => {
                if (data.instrumentKey?.toUpperCase() === currentUnderlying.toUpperCase() && data.ohlcv?.length > 0) {
                    const latest = data.ohlcv[data.ohlcv.length - 1];
                    const price = parseFloat(latest[4]);
                    if (!isNaN(price) && price > 0) {
                        document.getElementById('spotPrice').textContent = price.toLocaleString(undefined, {minimumFractionDigits: 2});
                    }
                }
            });

            socket.on('options_quote_update', (data) => {
                // Real-time quote updates for chain rows
                if (data.underlying === currentUnderlying) {
                    // Update LTP in the table if possible
                    const strike = data.symbol.match(/\d{5}/);
                    if (strike) {
                        // This would require a more complex mapping, skipping for now
                    }
                }
            });

            socket.on('options_alert', (data) => {
                showAlert(data.message);
            });

            socket.on('scalper_log', (data) => {
                const logEl = document.getElementById('scalperLog');
                const p = document.createElement('p');

                let message = data.message;
                if (!message && data.signal) {
                    // Structured signal log matching prompt requirements
                    message = `[${data.time}] [SIGNAL: ${data.signal}] [LVL: ${data.underlying_level}] [OI: ${data.oi_confirmation}] [INV: ${data.inverse_status}]`;
                    p.className = 'text-green-400 font-black bg-green-500/10 p-1 rounded border border-green-500/20 my-1';
                } else if (message) {
                    // Colorize simple logs
                    if (message.includes('ORDER SENT') || message.includes('SIGNAL')) p.className = 'text-green-400 font-bold';
                    else if (message.includes('ATM Switched') || message.includes('Fetching')) p.className = 'text-blue-400 italic';
                    else if (message.includes('CLOSED') || message.includes('RiskMgmt')) p.className = 'text-orange-400 font-bold';
                    else if (message.includes('ERROR')) p.className = 'text-red-500';
                    else p.className = 'text-gray-300';
                }

                p.textContent = message || "Unknown log event";
                logEl.appendChild(p);
                logEl.scrollTop = logEl.scrollHeight;

                // Sync status if needed
                updateScalperStatusUI();
            });

            socket.on('scalper_metrics', (data) => {
                const powerEl = document.getElementById('scalperOIPower');
                const sentimentEl = document.getElementById('scalperOISentiment');
                const statusEl = document.getElementById('scalperOIStatus');
                const zoneEl = document.getElementById('scalperSignalZone');
                const ceVwapEl = document.getElementById('ceVwap');
                const peVwapEl = document.getElementById('peVwap');

                if (powerEl) powerEl.textContent = data.oi_power;
                if (sentimentEl) {
                    sentimentEl.textContent = data.oi_sentiment;
                    if (data.oi_sentiment === 'BULLISH') sentimentEl.className = 'text-lg font-black text-green-500 mt-1';
                    else if (data.oi_sentiment === 'BEARISH') sentimentEl.className = 'text-lg font-black text-red-500 mt-1';
                    else sentimentEl.className = 'text-lg font-black text-white mt-1';
                }
                if (statusEl) {
                    statusEl.textContent = data.oi_status.replace('_', ' ');
                    if (data.oi_status === 'LONG_BUILDUP') statusEl.className = 'text-lg font-black text-green-500 mt-1';
                    else if (data.oi_status === 'SHORT_BUILDUP') statusEl.className = 'text-lg font-black text-red-500 mt-1';
                    else if (data.oi_status === 'SHORT_COVERING') statusEl.className = 'text-lg font-black text-blue-500 mt-1';
                    else if (data.oi_status === 'LONG_UNWINDING') statusEl.className = 'text-lg font-black text-orange-500 mt-1';
                    else statusEl.className = 'text-lg font-black text-white mt-1';
                }
                if (zoneEl) zoneEl.textContent = data.underlying_level || '-';
                if (ceVwapEl) ceVwapEl.textContent = data.vwap.call;
                if (peVwapEl) peVwapEl.textContent = data.vwap.put;

                // Confluence Check UI
                if (data.confluence) {
                    const updateConf = (id, active) => {
                        const el = document.getElementById(id);
                        if (!el) return;
                        if (active) {
                            el.classList.remove('opacity-40');
                            el.classList.add('bg-blue-500/20', 'border-blue-500/50', 'text-blue-400');
                        } else {
                            el.classList.add('opacity-40');
                            el.classList.remove('bg-blue-500/20', 'border-blue-500/50', 'text-blue-400');
                        }
                    };
                    updateConf('conf-lvl', data.confluence.lvl);
                    updateConf('conf-pcr', data.confluence.pcr);
                    updateConf('conf-oi', data.confluence.oi);
                    updateConf('conf-brk', data.confluence.opt_brk);
                    updateConf('conf-inv', data.confluence.inv_dwn);
                }
            });
        }

        function setupEventListeners() {
            // Underlying selector
            document.getElementById('underlyingSelect').addEventListener('change', (e) => {
                const oldUnderlying = currentUnderlying;
                currentUnderlying = e.target.value;

                socket.emit('unsubscribe_options', { underlying: oldUnderlying });
                socket.emit('unsubscribe', { instrumentKeys: [oldUnderlying], interval: '1' });

                socket.emit('subscribe_options', { underlying: currentUnderlying });
                socket.emit('subscribe', { instrumentKeys: [currentUnderlying], interval: '1' });

                loadData();
            });

            // Refresh button
            document.getElementById('refreshBtn').addEventListener('click', loadData);

            // Backfill button
            document.getElementById('backfillBtn').addEventListener('click', async () => {
                try {
                    const response = await fetch('/api/options/backfill', { method: 'POST' });
                    const data = await response.json();
                    showAlert(data.message);
                } catch (error) {
                    console.error('Backfill error:', error);
                }
            });

            // Alerts header button
            document.getElementById('alertsBtn').addEventListener('click', () => switchTab('alerts'));

            // Strategy header button
            document.getElementById('strategyBtn').addEventListener('click', () => switchTab('strategies'));

            // Theme toggle
            document.getElementById('optionsThemeToggle').addEventListener('click', () => {
                const isLight = document.body.classList.contains('light-theme');
                applyTheme(isLight ? 'dark' : 'light');
            });

            // Tab switching
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tabId = btn.dataset.tab;
                    switchTab(tabId);
                });
            });

            // Strategy builder
            document.getElementById('buildStrategyBtn')?.addEventListener('click', buildStrategy);

            // Strategy type change
            document.getElementById('strategyType').addEventListener('change', (e) => {
                const container = document.getElementById('customLegsContainer');
                if (e.target.value === 'custom') {
                    container.classList.remove('hidden');
                    if (document.getElementById('legsList').children.length === 0) {
                        addLegRow();
                    }
                } else {
                    container.classList.add('hidden');
                }
            });

            // Add leg button
            document.getElementById('addLegBtn').addEventListener('click', addLegRow);

            // Create Alert button
            document.getElementById('createAlertBtn').addEventListener('click', createAlert);

            // Scalper Start/Stop
            document.getElementById('startScalperBtn').addEventListener('click', startScalper);
            document.getElementById('stopScalperBtn').addEventListener('click', stopScalper);
            document.getElementById('clearLogBtn').addEventListener('click', () => {
                document.getElementById('scalperLog').innerHTML = '';
            });
        }

        function addLegRow() {
            const list = document.getElementById('legsList');
            const id = Date.now();
            const row = document.createElement('div');
            row.id = `leg-${id}`;
            row.className = 'grid grid-cols-5 gap-1 items-center bg-slate-800/50 p-2 rounded';
            row.innerHTML = `
                <input type="number" placeholder="Strike" class="col-span-2 bg-slate-900 border border-white/5 rounded px-1 py-1 text-[10px] strike-input">
                <select class="bg-slate-900 border border-white/5 rounded px-1 py-1 text-[10px] type-input">
                    <option value="call">CE</option>
                    <option value="put">PE</option>
                </select>
                <select class="bg-slate-900 border border-white/5 rounded px-1 py-1 text-[10px] pos-input">
                    <option value="long">Buy</option>
                    <option value="short">Sell</option>
                </select>
                <button onclick="document.getElementById('leg-${id}').remove()" class="text-red-500 text-[10px] font-bold">Ã—</button>
            `;
            list.appendChild(row);
        }

        function switchTab(tabId) {
            // Update active tab button
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('tab-active');
                if (btn.dataset.tab === tabId) {
                    btn.classList.add('tab-active');
                }
            });

            // Show active tab content
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.add('hidden');
            });
            document.getElementById(tabId + 'Tab').classList.remove('hidden');

            // Load tab-specific data
            if (tabId === 'oi-analysis') loadOIAnalysis();
            if (tabId === 'pcr-trend') loadPCRTrend();
            if (tabId === 'greeks') loadGreeks();
            if (tabId === 'buildup') loadBuildupAnalysis();
            if (tabId === 'alerts') loadAlerts();
            if (tabId === 'scalper') updateScalperStatusUI();
        }

        async function loadData() {
            try {
                // Load option chain
                const chainResponse = await fetch(`/api/options/chain/${currentUnderlying}/with-greeks`);
                const chainData = await chainResponse.json();

                // Load high activity strikes for highlighting
                const activityRes = await fetch(`/api/options/high-activity/${currentUnderlying}`);
                const activityData = await activityRes.json();
                const highActivityStrikes = new Set(activityData.map(s => s.strike));

                renderOptionChain(chainData, highActivityStrikes);

                // Load Genie Insights
                const genieRes = await fetch(`/api/options/genie-insights/${currentUnderlying}`);
                const genieData = await genieRes.json();
                updateGenieCard(genieData);

                // Update source if available
                if (chainData.source) {
                    document.getElementById('dataSource').textContent = chainData.source.toUpperCase();
                }

                // Load summary data
                const oiResponse = await fetch(`/api/options/oi-analysis/${currentUnderlying}`);
                const oiData = await oiResponse.json();
                updateSummaryCards(oiData);

                // Load IV analysis
                const ivResponse = await fetch(`/api/options/iv-analysis/${currentUnderlying}`);
                const ivData = await ivResponse.json();
                updateIVCard(ivData);

                // Load PCR Trend for summary cards
                await loadPCRTrend();

                // Update timestamp
                document.getElementById('lastUpdated').textContent = formatIST(new Date());
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        function renderOptionChain(data, highActivityStrikes = new Set()) {
            const tbody = document.getElementById('optionChainBody');
            tbody.innerHTML = '';

            const chain = data.chain || [];
            const spotPrice = data.spot_price || 0;

            // Update Summary Card
            document.getElementById('spotPrice').textContent = spotPrice.toLocaleString(undefined, {minimumFractionDigits: 2});
            document.getElementById('aimSpot').textContent = spotPrice.toFixed(0);

            if (chain.length === 0) {
                tbody.innerHTML = '<tr><td colspan="13" class="py-10 text-center text-gray-500 font-bold">No data available. Please click "Backfill" or wait for the next snapshot.</td></tr>';
                return;
            }

            // Group by strike
            const strikes = {};
            chain.forEach(item => {
                if (!strikes[item.strike]) {
                    strikes[item.strike] = { call: null, put: null };
                }
                strikes[item.strike][item.option_type] = item;
            });

            // Sort strikes
            const sortedStrikes = Object.keys(strikes).sort((a, b) => parseFloat(a) - parseFloat(b));

            sortedStrikes.forEach(strike => {
                const data = strikes[strike];
                const call = data.call || {};
                const put = data.put || {};

                const isATM = Math.abs(parseFloat(strike) - spotPrice) / spotPrice < 0.01;
                const isHighActivity = highActivityStrikes.has(parseFloat(strike));

                let rowClass = isATM ? 'bg-blue-500/10' : '';
                if (isHighActivity) rowClass = 'bg-yellow-500/5 border-l-2 border-yellow-500/50';

                const row = document.createElement('tr');
                row.className = `${rowClass} hover:bg-white/5 transition-colors`;
                row.innerHTML = `
                    <td class="py-2 px-3 text-right text-gray-400">${call.iv || '-'}</td>
                    <td class="py-2 px-3 text-right ${call.delta > 0 ? 'greek-positive' : 'greek-negative'}">${call.delta?.toFixed(2) || '-'}</td>
                    <td class="py-2 px-3 text-right text-gray-400">${call.theta?.toFixed(2) || '-'}</td>
                    <td class="py-2 px-3 text-right font-bold text-green-400">${call.ltp?.toFixed(2) || '-'}</td>
                    <td class="py-2 px-3 text-right ${call.oi_change > 0 ? 'text-green-400' : 'text-red-400'}">${call.oi_change || '-'}</td>
                    <td class="py-2 px-3 text-right border-r border-white/5">${call.oi?.toLocaleString() || '-'}</td>
                    <td class="py-2 px-3 text-center font-black text-sm ${isATM ? 'text-blue-400' : (isHighActivity ? 'text-yellow-400' : 'text-white')} bg-slate-800">${strike}</td>
                    <td class="py-2 px-3 text-left">${put.oi?.toLocaleString() || '-'}</td>
                    <td class="py-2 px-3 text-left ${put.oi_change > 0 ? 'text-green-400' : 'text-red-400'}">${put.oi_change || '-'}</td>
                    <td class="py-2 px-3 text-left font-bold text-red-400">${put.ltp?.toFixed(2) || '-'}</td>
                    <td class="py-2 px-3 text-left text-gray-400">${put.theta?.toFixed(2) || '-'}</td>
                    <td class="py-2 px-3 text-left ${put.delta > 0 ? 'greek-positive' : 'greek-negative'}">${put.delta?.toFixed(2) || '-'}</td>
                    <td class="py-2 px-3 text-left text-gray-400">${put.iv || '-'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateSummaryCards(data) {
            const oiData = data.data || [];
            
            // Calculate totals
            let totalCallOI = 0, totalPutOI = 0;
            let totalCallOIChange = 0, totalPutOIChange = 0;

            oiData.forEach(item => {
                totalCallOI += item.call_oi || 0;
                totalPutOI += item.put_oi || 0;
                totalCallOIChange += item.call_oi_change || 0;
                totalPutOIChange += item.put_oi_change || 0;
            });

            const pcr = totalCallOI > 0 ? (totalPutOI / totalCallOI).toFixed(2) : '0.00';
            const pcrVol = totalCallOIChange > 0 ? (totalPutOIChange / totalCallOIChange).toFixed(2) : '0.00';

            document.getElementById('pcrValue').textContent = pcr;
            document.getElementById('pcrVol').textContent = pcrVol;

            // PCR Signal - Decisive Thresholds for Indices
            const pcrSignal = document.getElementById('pcrSignal');
            if (pcr > 1.3) {
                pcrSignal.textContent = 'OVERBOUGHT';
                pcrSignal.className = 'text-[10px] font-black bg-red-500/20 text-red-500 px-2 py-0.5 rounded uppercase';
            } else if (pcr > 1.1) {
                pcrSignal.textContent = 'BEARISH';
                pcrSignal.className = 'text-[10px] font-black bg-red-400/20 text-red-400 px-2 py-0.5 rounded uppercase';
            } else if (pcr < 0.7) {
                pcrSignal.textContent = 'OVERSOLD';
                pcrSignal.className = 'text-[10px] font-black bg-green-500/20 text-green-500 px-2 py-0.5 rounded uppercase';
            } else if (pcr < 0.9) {
                pcrSignal.textContent = 'BULLISH';
                pcrSignal.className = 'text-[10px] font-black bg-green-400/20 text-green-400 px-2 py-0.5 rounded uppercase';
            } else {
                pcrSignal.textContent = 'NEUTRAL';
                pcrSignal.className = 'text-[10px] font-black bg-gray-500/20 text-gray-400 px-2 py-0.5 rounded uppercase';
            }
        }

        function updateIVCard(data) {
            document.getElementById('ivRank').textContent = data.iv_rank !== undefined ? data.iv_rank + '%' : '-';
            document.getElementById('ivValue').textContent = data.current_iv !== undefined ? data.current_iv + '%' : '-';

            const ivSignal = document.getElementById('ivSignal');
            if (data.iv_rank > 70) {
                ivSignal.textContent = 'HIGH';
                ivSignal.className = 'text-[10px] font-black bg-red-500/20 text-red-500 px-2 py-0.5 rounded uppercase';
            } else if (data.iv_rank < 30) {
                ivSignal.textContent = 'LOW';
                ivSignal.className = 'text-[10px] font-black bg-green-500/20 text-green-500 px-2 py-0.5 rounded uppercase';
            } else {
                ivSignal.textContent = 'NORMAL';
                ivSignal.className = 'text-[10px] font-black bg-gray-500/20 text-gray-400 px-2 py-0.5 rounded uppercase';
            }
        }

        function updateGenieCard(data) {
            const controlEl = document.getElementById('genieControl');
            const distEl = document.getElementById('genieDistribution');
            const rangeEl = document.getElementById('genieRange');
            const sidewaysBadge = document.getElementById('sidewaysBadge');

            controlEl.textContent = data.control.replace('_', ' ');
            if (data.control === 'BUYERS_IN_CONTROL') controlEl.className = 'text-lg font-black text-green-500 uppercase';
            else if (data.control === 'SELLERS_IN_CONTROL') controlEl.className = 'text-lg font-black text-red-500 uppercase';
            else controlEl.className = 'text-lg font-black text-white uppercase';

            distEl.textContent = data.distribution.status;
            distEl.className = data.distribution.is_aggressive_distribution ? 'text-[9px] font-black text-red-400 mt-1 uppercase' : 'text-[9px] font-bold text-gray-500 mt-1 uppercase';

            rangeEl.textContent = `${data.boundaries.lower} - ${data.boundaries.upper}`;

            if (data.sideways_expected) sidewaysBadge.classList.remove('hidden');
            else sidewaysBadge.classList.add('hidden');
        }

        async function loadOIAnalysis() {
            try {
                const response = await fetch(`/api/options/oi-analysis/${currentUnderlying}`);
                const data = await response.json();
                renderOIChart(data);

                // Load support/resistance
                const srResponse = await fetch(`/api/options/support-resistance/${currentUnderlying}`);
                const srData = await srResponse.json();
                renderSupportResistance(srData);
            } catch (error) {
                console.error('Error loading OI analysis:', error);
            }
        }

        function renderOIChart(data) {
            const ctx = document.getElementById('oiChart').getContext('2d');
            
            if (charts.oi) {
                charts.oi.destroy();
            }

            const oiData = data.data || [];
            const strikes = oiData.map(d => d.strike);
            const callOI = oiData.map(d => d.call_oi);
            const putOI = oiData.map(d => d.put_oi);

            charts.oi = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: strikes,
                    datasets: [
                        {
                            label: 'Call OI',
                            data: callOI,
                            backgroundColor: 'rgba(34, 197, 94, 0.6)',
                            borderColor: 'rgba(34, 197, 94, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Put OI',
                            data: putOI,
                            backgroundColor: 'rgba(239, 68, 68, 0.6)',
                            borderColor: 'rgba(239, 68, 68, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { ticks: { color: '#94a3b8', font: { size: 9 } } },
                        y: { ticks: { color: '#94a3b8', font: { size: 9 } } }
                    },
                    plugins: {
                        legend: { labels: { color: '#f8fafc', font: { size: 10 } } }
                    }
                }
            });
        }

        function renderSupportResistance(data) {
            const container = document.getElementById('supportResistance');
            container.innerHTML = '';

            const resistance = data.resistance_levels || [];
            const support = data.support_levels || [];

            // Distribution/Accumulation Summary
            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'grid grid-cols-2 gap-4 mb-4';
            summaryDiv.innerHTML = `
                <div class="bg-red-500/10 border border-red-500/20 rounded p-3 text-center">
                    <div class="text-[8px] text-red-400 uppercase font-black">Institutional Distribution</div>
                    <div class="text-lg font-black text-white mt-1">${resistance[0]?.strike || '-'}</div>
                    <div class="text-[8px] text-gray-500">HEAVY CALL WRITING</div>
                </div>
                <div class="bg-green-500/10 border border-green-500/20 rounded p-3 text-center">
                    <div class="text-[8px] text-green-400 uppercase font-black">Institutional Accumulation</div>
                    <div class="text-lg font-black text-white mt-1">${support[0]?.strike || '-'}</div>
                    <div class="text-[8px] text-gray-500">HEAVY PUT WRITING</div>
                </div>
            `;
            container.appendChild(summaryDiv);

            // Detailed Levels (OiGenie Style)
            const levelsDiv = document.createElement('div');
            levelsDiv.className = 'space-y-1';

            // Merge and sort all levels
            const allLevels = [
                ...resistance.map(l => ({...l, type: 'RES'})),
                ...support.map(l => ({...l, type: 'SUP'}))
            ].sort((a, b) => b.strike - a.strike);

            allLevels.forEach(level => {
                const isSup = level.type === 'SUP';
                const color = isSup ? 'text-green-500' : 'text-red-500';
                const bgColor = isSup ? 'bg-green-500/5' : 'bg-red-500/5';
                const borderColor = isSup ? 'border-green-500/20' : 'border-red-500/20';

                // Strength calculation for label (ss)
                const label = level.oi > 1000000 ? '(ss)' : level.oi > 500000 ? '(s)' : '';

                levelsDiv.innerHTML += `
                    <div class="flex justify-between items-center py-2 px-3 ${bgColor} border-l-4 ${borderColor} rounded-r">
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-black ${color}">${level.strike}</span>
                            <span class="text-[10px] text-gray-500 font-bold">${isSup ? 'â†“' : 'â†‘'}</span>
                        </div>
                        <div class="flex items-center gap-4">
                            <span class="text-[9px] text-gray-400">OI: ${(level.oi/1000000).toFixed(1)}M</span>
                            <span class="text-[10px] font-black ${color}">${label}</span>
                        </div>
                    </div>
                `;
            });
            container.appendChild(levelsDiv);
        }

        async function loadPCRTrend() {
            try {
                const response = await fetch(`/api/options/pcr-trend/${currentUnderlying}`);
                const data = await response.json();
                renderPCRChart(data);

                // Update Max Pain from latest trend data
                if (data.history && data.history.length > 0) {
                    const latest = data.history[data.history.length - 1];
                    const maxPain = latest.max_pain || 0;
                    const spot = latest.spot_price || latest.underlying_price || 0;

                    document.getElementById('maxPain').textContent = maxPain.toLocaleString();

                    if (spot > 0) {
                        // Backup update for spot price
                        const spotEl = document.getElementById('spotPrice');
                        if (spotEl.textContent === '0.00' || spotEl.textContent === '-') {
                            spotEl.textContent = spot.toLocaleString(undefined, {minimumFractionDigits: 2});
                        }

                        const diff = maxPain - spot;
                        const diffPct = (diff / spot * 100).toFixed(2);
                        const diffEl = document.getElementById('maxPainDiff');
                        diffEl.textContent = `${diff > 0 ? '+' : ''}${diff.toLocaleString()} (${diffPct}%)`;
                        diffEl.className = `text-[10px] font-black ${diff >= 0 ? 'text-green-500' : 'text-red-500'}`;
                    }
                }
            } catch (error) {
                console.error('Error loading PCR trend:', error);
            }
        }

        function renderPCRChart(data) {
            const history = data.history || [];
            const timestamps = history.map(h => formatIST(h.timestamp));
            const theme = localStorage.getItem('theme') || 'light';
            const textColor = theme === 'light' ? '#0f172a' : '#f8fafc';
            const mutedColor = theme === 'light' ? '#475569' : '#94a3b8';

            // 1. Confluence Chart (Spot + PCR)
            const confCtx = document.getElementById('confluenceChart').getContext('2d');
            if (charts.confluence) charts.confluence.destroy();

            charts.confluence = new Chart(confCtx, {
                type: 'line',
                data: {
                    labels: timestamps,
                    datasets: [
                        {
                            label: 'Spot Price',
                            data: history.map(h => h.spot_price || h.underlying_price),
                            borderColor: theme === 'light' ? '#2563eb' : '#3b82f6',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.2,
                            pointRadius: 0,
                            yAxisID: 'y-spot'
                        },
                        {
                            label: 'PCR (OI)',
                            data: history.map(h => h.pcr_oi),
                            borderColor: 'rgba(34, 197, 94, 1)',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            fill: true,
                            tension: 0.4,
                            yAxisID: 'y-pcr'
                        },
                        // {
                        //     label: 'PCR (Vol)',
                        //     data: history.map(h => h.pcr_vol),
                        //     borderColor: 'rgba(168, 85, 247, 1)',
                        //     backgroundColor: 'rgba(168, 85, 247, 0.1)',
                        //     fill: false,
                        //     borderDash: [5, 5],
                        //     tension: 0.4,
                        //     yAxisID: 'y-pcr'
                        // }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        x: { ticks: { color: mutedColor, font: { size: 9 } } },
                        'y-spot': {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            ticks: { color: '#3b82f6', font: { size: 9, weight: 'bold' } },
                            beginAtZero: false,
                            title: { display: true, text: 'SPOT PRICE', color: '#3b82f6', font: { size: 10, weight: 'bold' } }
                        },
                        'y-pcr': {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            ticks: { color: '#22c55e', font: { size: 9, weight: 'bold' } },
                            grid: { drawOnChartArea: false },
                            
                            // Autoscale logic
                            beginAtZero: false,      // Allows the axis to start at the data's minimum
                            suggestedMin: undefined, // Let Chart.js determine the min from data
                            suggestedMax: undefined, // Let Chart.js determine the max from data
                            grace: '5%',              // Optional: Adds a small buffer above/below data
                            
                            // suggestedMin: 0.5,
                            // suggestedMax: 1.5,
                            title: { display: true, text: 'PCR', color: '#22c55e', font: { size: 10, weight: 'bold' } }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: textColor, font: { size: 10 } } }
                    }
                }
            });

            // 2. Total OI Chart
            const oiCtx = document.getElementById('totalOIChart').getContext('2d');
            if (charts.totalOI) charts.totalOI.destroy();

            charts.totalOI = new Chart(oiCtx, {
                type: 'line',
                data: {
                    labels: timestamps,
                    datasets: [{
                        label: 'Total OI',
                        data: history.map(h => h.total_oi || 0),
                        borderColor: 'rgba(34, 197, 94, 1)',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { ticks: { color: '#94a3b8', font: { size: 9 } } },
                        y: { ticks: { color: '#94a3b8', font: { size: 9 } } }
                    },
                    plugins: { legend: { display: false } }
                }
            });

            // 4. OI Change Chart
            const oicCtx = document.getElementById('oiChangeChart').getContext('2d');
            if (charts.oiChange) charts.oiChange.destroy();

            charts.oiChange = new Chart(oicCtx, {
                type: 'bar',
                data: {
                    labels: timestamps,
                    datasets: [{
                        label: 'OI Change',
                        data: history.map(h => h.total_oi_change || 0),
                        backgroundColor: history.map(h => (h.total_oi_change || 0) >= 0 ? 'rgba(34, 197, 94, 0.6)' : 'rgba(239, 68, 68, 0.6)'),
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { ticks: { color: '#94a3b8', font: { size: 9 } } },
                        y: { ticks: { color: '#94a3b8', font: { size: 9 } } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        async function loadGreeks() {
            try {
                const response = await fetch(`/api/options/chain/${currentUnderlying}/with-greeks`);
                const data = await response.json();
                renderGreeksCharts(data);
            } catch (error) {
                console.error('Error loading Greeks:', error);
            }
        }

        function renderGreeksCharts(data) {
            const chain = data.chain || [];
            const strikes = [...new Set(chain.map(c => c.strike))].sort((a, b) => a - b);

            // Delta chart
            const deltaCtx = document.getElementById('deltaChart').getContext('2d');
            if (charts.delta) charts.delta.destroy();

            const callDeltas = strikes.map(s => {
                const item = chain.find(c => c.strike === s && c.option_type === 'call');
                return item ? item.delta : 0;
            });
            const putDeltas = strikes.map(s => {
                const item = chain.find(c => c.strike === s && c.option_type === 'put');
                return item ? item.delta : 0;
            });

            charts.delta = new Chart(deltaCtx, {
                type: 'line',
                data: {
                    labels: strikes,
                    datasets: [
                        {
                            label: 'Call Delta',
                            data: callDeltas,
                            borderColor: 'rgba(34, 197, 94, 1)',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            fill: false
                        },
                        {
                            label: 'Put Delta',
                            data: putDeltas,
                            borderColor: 'rgba(239, 68, 68, 1)',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { ticks: { color: '#94a3b8', font: { size: 9 } } },
                        y: { ticks: { color: '#94a3b8', font: { size: 9 } } }
                    },
                    plugins: {
                        legend: { labels: { color: '#f8fafc', font: { size: 10 } } }
                    }
                }
            });

            // Theta chart
            const thetaCtx = document.getElementById('thetaChart').getContext('2d');
            if (charts.theta) charts.theta.destroy();

            const callThetas = strikes.map(s => {
                const item = chain.find(c => c.strike === s && c.option_type === 'call');
                return item ? item.theta : 0;
            });
            const putThetas = strikes.map(s => {
                const item = chain.find(c => c.strike === s && c.option_type === 'put');
                return item ? item.theta : 0;
            });

            charts.theta = new Chart(thetaCtx, {
                type: 'bar',
                data: {
                    labels: strikes,
                    datasets: [
                        {
                            label: 'Call Theta',
                            data: callThetas,
                            backgroundColor: 'rgba(34, 197, 94, 0.6)'
                        },
                        {
                            label: 'Put Theta',
                            data: putThetas,
                            backgroundColor: 'rgba(239, 68, 68, 0.6)'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { ticks: { color: '#94a3b8', font: { size: 9 } } },
                        y: { ticks: { color: '#94a3b8', font: { size: 9 } } }
                    },
                    plugins: {
                        legend: { labels: { color: '#f8fafc', font: { size: 10 } } }
                    }
                }
            });
        }

        async function loadBuildupAnalysis() {
            try {
                const response = await fetch(`/api/options/oi-buildup/${currentUnderlying}`);
                const data = await response.json();
                renderBuildupAnalysis(data);
            } catch (error) {
                console.error('Error loading buildup analysis:', error);
            }
        }

        function renderBuildupAnalysis(data) {
            const container = document.getElementById('buildupAnalysis');
            container.innerHTML = '';

            const summary = data.summary || {};
            const signals = data.signals || [];

            // Pattern distribution
            const patterns = summary.pattern_distribution || {};
            
            const patternColors = {
                'Long Buildup': 'bg-green-500/20 text-green-500',
                'Short Buildup': 'bg-red-500/20 text-red-500',
                'Long Unwinding': 'bg-orange-500/20 text-orange-500',
                'Short Covering': 'bg-blue-500/20 text-blue-500',
                'Neutral': 'bg-gray-500/20 text-gray-500'
            };

            Object.entries(patterns).forEach(([pattern, count]) => {
                const div = document.createElement('div');
                div.className = 'glass-panel rounded-xl p-3';
                div.innerHTML = `
                    <div class="text-[10px] text-gray-400 uppercase">${pattern}</div>
                    <div class="text-2xl font-black ${patternColors[pattern] || 'text-white'} rounded px-2 py-1 mt-1 inline-block">${count}</div>
                `;
                container.appendChild(div);
            });

            // Strong signals
            const strongSignals = signals.filter(s => s.strength === 'strong').slice(0, 5);
            if (strongSignals.length > 0) {
                const signalsDiv = document.createElement('div');
                signalsDiv.className = 'glass-panel rounded-xl p-3 lg:col-span-2';
                signalsDiv.innerHTML = '<div class="text-[10px] text-gray-400 uppercase mb-2">Strong Signals</div>';
                
                strongSignals.forEach(signal => {
                    const color = signal.buildup_type.includes('Long') ? 'text-green-500' : 
                                  signal.buildup_type.includes('Short') ? 'text-red-500' : 'text-gray-400';
                    signalsDiv.innerHTML += `
                        <div class="flex justify-between items-center py-1 text-xs">
                            <span class="font-bold">${signal.strike} ${signal.option_type.toUpperCase()}</span>
                            <span class="${color}">${signal.buildup_type}</span>
                        </div>
                    `;
                });
                
                container.appendChild(signalsDiv);
            }
        }

        async function buildStrategy() {
            const strategyType = document.getElementById('strategyType').value;
            
            try {
                let endpoint = '';
                let body = {};

                // Get current spot price
                const chainResponse = await fetch(`/api/options/chain/${currentUnderlying}/with-greeks`);
                const chainData = await chainResponse.json();
                const spotPrice = chainData.spot_price || 0;

                switch(strategyType) {
                    case 'bull_call_spread':
                        endpoint = '/api/strategy/bull-call-spread';
                        body = {
                            underlying: currentUnderlying,
                            spot_price: spotPrice,
                            lower_strike: Math.floor(spotPrice / 100) * 100,
                            higher_strike: Math.ceil((spotPrice + 200) / 100) * 100,
                            lower_premium: 50,
                            higher_premium: 20,
                            expiry: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
                        };
                        break;
                    case 'iron_condor':
                        endpoint = '/api/strategy/iron-condor';
                        body = {
                            underlying: currentUnderlying,
                            spot_price: spotPrice,
                            put_sell_strike: Math.floor((spotPrice - 200) / 100) * 100,
                            put_buy_strike: Math.floor((spotPrice - 400) / 100) * 100,
                            call_sell_strike: Math.ceil((spotPrice + 200) / 100) * 100,
                            call_buy_strike: Math.ceil((spotPrice + 400) / 100) * 100,
                            premiums: { put_buy: 10, put_sell: 25, call_sell: 25, call_buy: 10 },
                            expiry: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
                        };
                        break;
                    case 'long_straddle':
                        endpoint = '/api/strategy/long-straddle';
                        body = {
                            underlying: currentUnderlying,
                            spot_price: spotPrice,
                            strike: Math.round(spotPrice / 100) * 100,
                            call_premium: 80,
                            put_premium: 70,
                            expiry: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
                        };
                        break;
                    case 'custom':
                        endpoint = '/api/strategy/build';
                        const legs = [];
                        document.querySelectorAll('#legsList > div').forEach(row => {
                            legs.push({
                                strike: parseFloat(row.querySelector('.strike-input').value),
                                option_type: row.querySelector('.type-input').value,
                                position: row.querySelector('.pos-input').value,
                                quantity: 1,
                                premium: 10, // Default for analysis
                                expiry: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
                            });
                        });
                        body = {
                            name: 'Custom Strategy',
                            strategy_type: 'CUSTOM',
                            underlying: currentUnderlying,
                            spot_price: spotPrice,
                            legs: legs
                        };
                        break;
                }

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                const data = await response.json();
                renderStrategyAnalysis(data.analysis);
            } catch (error) {
                console.error('Error building strategy:', error);
            }
        }

        function renderStrategyAnalysis(analysis) {
            const container = document.getElementById('strategyAnalysis');
            const chartContainer = document.getElementById('payoffChartContainer');
            
            if (!analysis || analysis.error) {
                container.innerHTML = `<p class="text-red-500 text-xs">Error: ${analysis?.error || 'Failed to load analysis'}</p>`;
                chartContainer.classList.add('hidden');
                return;
            }

            container.innerHTML = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                        <div class="bg-slate-900/50 rounded p-2">
                            <div class="text-[8px] text-gray-500 uppercase">Net Premium</div>
                            <div class="text-sm font-bold ${analysis.net_premium >= 0 ? 'text-green-500' : 'text-red-500'}">${analysis.net_premium > 0 ? '+' : ''}${analysis.net_premium}</div>
                        </div>
                        <div class="bg-slate-900/50 rounded p-2">
                            <div class="text-[8px] text-gray-500 uppercase">Max Profit</div>
                            <div class="text-sm font-bold text-green-500">${analysis.max_profit}</div>
                        </div>
                        <div class="bg-slate-900/50 rounded p-2">
                            <div class="text-[8px] text-gray-500 uppercase">Max Loss</div>
                            <div class="text-sm font-bold text-red-500">${analysis.max_loss}</div>
                        </div>
                        <div class="bg-slate-900/50 rounded p-2">
                            <div class="text-[8px] text-gray-500 uppercase">Breakeven</div>
                            <div class="text-sm font-bold text-blue-500">${analysis.breakeven_points?.length > 0 ? analysis.breakeven_points.map(b => Math.round(b)).join(', ') : '-'}</div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                        <div class="bg-slate-900/50 rounded p-2">
                            <div class="text-[8px] text-gray-500 uppercase">Delta</div>
                            <div class="text-sm font-bold">${analysis.net_delta}</div>
                        </div>
                        <div class="bg-slate-900/50 rounded p-2">
                            <div class="text-[8px] text-gray-500 uppercase">Gamma</div>
                            <div class="text-sm font-bold">${analysis.net_gamma}</div>
                        </div>
                        <div class="bg-slate-900/50 rounded p-2">
                            <div class="text-[8px] text-gray-500 uppercase">Theta</div>
                            <div class="text-sm font-bold ${analysis.net_theta >= 0 ? 'text-green-500' : 'text-red-500'}">${analysis.net_theta}</div>
                        </div>
                        <div class="bg-slate-900/50 rounded p-2">
                            <div class="text-[8px] text-gray-500 uppercase">Vega</div>
                            <div class="text-sm font-bold">${analysis.net_vega}</div>
                        </div>
                    </div>

                    <div>
                        <h4 class="text-[9px] text-gray-400 uppercase mb-1">Legs</h4>
                        <div class="space-y-1">
                            ${analysis.legs?.map(leg => `
                                <div class="flex justify-between items-center bg-slate-900/50 rounded px-2 py-1 text-[10px]">
                                    <div class="flex gap-2">
                                        <span class="font-bold uppercase ${leg.position === 'long' ? 'text-blue-500' : 'text-orange-500'}">${leg.position}</span>
                                        <span>${leg.strike} ${leg.option_type.toUpperCase()}</span>
                                    </div>
                                    <div class="${leg.net_premium >= 0 ? 'text-green-500' : 'text-red-500'}">${leg.net_premium}</div>
                                </div>
                            `).join('') || ''}
                        </div>
                    </div>
                </div>
            `;

            if (analysis.payoff_chart_data) {
                chartContainer.classList.remove('hidden');
                renderPayoffChart(analysis.payoff_chart_data);
            } else {
                chartContainer.classList.add('hidden');
            }
        }

        function renderPayoffChart(data) {
            const ctx = document.getElementById('payoffChart').getContext('2d');
            if (charts.payoff) charts.payoff.destroy();

            charts.payoff = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.prices.map(p => Math.round(p)),
                    datasets: [{
                        label: 'P&L',
                        data: data.pnl,
                        borderColor: '#3b82f6',
                        backgroundColor: (context) => {
                            const chart = context.chart;
                            const {ctx, chartArea} = chart;
                            if (!chartArea) return null;
                            const zero = chart.scales.y.getPixelForValue(0);
                            const gradient = ctx.createLinearGradient(0, chartArea.top, 0, chartArea.bottom);
                            const zeroPos = (zero - chartArea.top) / (chartArea.bottom - chartArea.top);
                            if (zeroPos > 0 && zeroPos < 1) {
                                gradient.addColorStop(0, 'rgba(34, 197, 94, 0.2)');
                                gradient.addColorStop(zeroPos, 'rgba(34, 197, 94, 0)');
                                gradient.addColorStop(zeroPos, 'rgba(239, 68, 68, 0)');
                                gradient.addColorStop(1, 'rgba(239, 68, 68, 0.2)');
                            }
                            return gradient;
                        },
                        fill: true,
                        tension: 0.3,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: (context) => `P&L: ${context.parsed.y.toFixed(2)}`
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            ticks: { color: '#64748b', font: { size: 8 } }
                        },
                        y: {
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            ticks: { color: '#64748b', font: { size: 8 } }
                        }
                    }
                }
            });
        }

        async function loadAlerts() {
            const list = document.getElementById('alertsList');
            try {
                const response = await fetch(`/api/alerts?underlying=${currentUnderlying}`);
                const data = await response.json();

                if (!data.alerts || data.alerts.length === 0) {
                    list.innerHTML = '<p class="text-gray-500 text-xs">No active alerts for this underlying</p>';
                    return;
                }

                list.innerHTML = data.alerts.map(alert => `
                    <div class="glass-panel rounded p-3 flex justify-between items-center">
                        <div>
                            <div class="text-xs font-bold">${alert.name}</div>
                            <div class="text-[10px] text-gray-400">${alert.alert_type.replace('_', ' ')}: ${alert.condition.threshold}</div>
                            <div class="text-[9px] ${alert.status === 'active' ? 'text-green-500' : 'text-yellow-500'} uppercase font-bold">${alert.status}</div>
                        </div>
                        <div class="flex gap-2">
                            ${alert.status === 'active'
                                ? `<button onclick="pauseAlert('${alert.id}')" class="text-yellow-500 text-[10px] font-bold uppercase">Pause</button>`
                                : `<button onclick="resumeAlert('${alert.id}')" class="text-green-500 text-[10px] font-bold uppercase">Resume</button>`
                            }
                            <button onclick="deleteAlert('${alert.id}')" class="text-red-500 text-[10px] font-bold uppercase">Delete</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading alerts:', error);
                list.innerHTML = '<p class="text-red-500 text-xs">Error loading alerts</p>';
            }
        }

        async function createAlert() {
            const name = document.getElementById('alertName').value;
            const type = document.getElementById('alertType').value;
            const threshold = parseFloat(document.getElementById('alertThreshold').value);

            if (!name || isNaN(threshold)) {
                showAlert('Please enter alert name and threshold');
                return;
            }

            try {
                const response = await fetch('/api/alerts/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name,
                        alert_type: type,
                        underlying: currentUnderlying,
                        condition: { threshold: threshold },
                        cooldown_minutes: 15
                    })
                });

                const data = await response.json();
                if (data.status === 'success') {
                    showAlert('Alert created successfully');
                    loadAlerts();
                    // Clear inputs
                    document.getElementById('alertName').value = '';
                    document.getElementById('alertThreshold').value = '';
                }
            } catch (error) {
                console.error('Error creating alert:', error);
                showAlert('Failed to create alert');
            }
        }

        async function pauseAlert(id) {
            await fetch(`/api/alerts/${id}/pause`, { method: 'POST' });
            loadAlerts();
        }

        async function resumeAlert(id) {
            await fetch(`/api/alerts/${id}/resume`, { method: 'POST' });
            loadAlerts();
        }

        async function deleteAlert(id) {
            if (confirm('Are you sure you want to delete this alert?')) {
                await fetch(`/api/alerts/${id}`, { method: 'DELETE' });
                loadAlerts();
            }
        }

        // ==================== SCALPER LOGIC ====================

        async function updateScalperStatusUI() {
            try {
                const response = await fetch('/api/scalper/status');
                const data = await response.json();

                const dot = document.getElementById('statusDot');
                const text = document.getElementById('statusText');
                const startBtn = document.getElementById('startScalperBtn');
                const stopBtn = document.getElementById('stopScalperBtn');

                if (data.is_running) {
                    dot.className = 'w-2 h-2 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)]';
                    text.textContent = 'Active: ' + data.underlying;
                    text.className = 'text-[10px] font-bold text-green-400 uppercase';
                    startBtn.classList.add('hidden');
                    stopBtn.classList.remove('hidden');
                } else {
                    dot.className = 'w-2 h-2 rounded-full bg-red-500';
                    text.textContent = 'Inactive';
                    text.className = 'text-[10px] font-bold text-gray-400 uppercase';
                    startBtn.classList.remove('hidden');
                    stopBtn.classList.add('hidden');
                }

                // Update active trades
                const tradesList = document.getElementById('activeTradesList');
                if (data.active_trades && data.active_trades.length > 0) {
                    tradesList.innerHTML = data.active_trades.map(t => `
                        <div class="bg-slate-900/50 border border-white/5 rounded p-2">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-[10px] font-black ${t.side === 'CALL' ? 'text-green-500' : 'text-red-500'}">${t.side}</span>
                                <span class="text-[10px] font-bold text-blue-400">LTP: ${t.last_price}</span>
                            </div>
                            <div class="flex justify-between text-[8px] text-gray-500">
                                <span>Entry: ${t.entry_price}</span>
                                <span>SL: ${t.sl}</span>
                                <span>TP: ${t.tp}</span>
                            </div>
                        </div>
                    `).join('');
                } else {
                    tradesList.innerHTML = '<p class="text-[10px] text-gray-500">No active trades</p>';
                }

            } catch (error) {
                console.error('Error updating scalper UI:', error);
            }
        }

        async function startScalper() {
            const underlying = document.getElementById('scalperUnderlying').value;
            try {
                const response = await fetch(`/api/scalper/start?underlying=${underlying}`, { method: 'POST' });
                const data = await response.json();
                updateScalperStatusUI();
            } catch (error) {
                console.error('Error starting scalper:', error);
            }
        }

        async function stopScalper() {
            try {
                const response = await fetch('/api/scalper/stop', { method: 'POST' });
                const data = await response.json();
                updateScalperStatusUI();
            } catch (error) {
                console.error('Error stopping scalper:', error);
            }
        }

        function showAlert(message) {
            // Simple alert - can be enhanced with toast notifications
            alert(message);
        }
    </script>
</body>
</html>
